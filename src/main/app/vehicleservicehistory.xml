<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq"
	xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp" xmlns:schedulers="http://www.mulesoft.org/schema/mule/schedulers"
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/schedulers http://www.mulesoft.org/schema/mule/schedulers/current/mule-schedulers.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<!-- 
	<spring:beans>
		<spring:import resource="classpath:batch_framework_configuration.xml"/>
		<spring:import resource="classpath:queue_mechanism.xml"/>
		
	</spring:beans> -->

	<batch:job name="vehicleservicehistory">

		<batch:process-records>
			<batch:step name="EachRecordFile">
                    <validation:all doc:name="Data Validation">
                        <validation:validations>
                            <validation:is-empty value="#[payload]" message="File is empty" exceptionClass="org.apache.poi.EmptyFileException"/>
                        </validation:validations>
                    </validation:all>
                    <dw:transform-message doc:name="Transform Record to Queue">
                        <dw:set-payload><![CDATA[%dw 1.0
%output application/java
---
payload]]></dw:set-payload>
                    </dw:transform-message>

			</batch:step>
            <batch:step name="RecordToAnypointMQ">
                <flow-ref name="queue" doc:name="queue"/>
            </batch:step>
            <batch:step name="RecordToVehicleAssociationSystemAPI">
                <http:request config-ref="http_Request_Configuration" path="vehicle_association_api" method="POST" doc:name="HTTP"/>
            </batch:step>

			<batch:step name="LogFailureSteps" accept-policy="ONLY_FAILURES"
				accept-expression="#[payload.id!=null]">
				<logger level="ERROR" doc:name="Failure" message="Failure because #[payload]" />
			</batch:step>
		</batch:process-records>
		<batch:on-complete>
			<json:object-to-json-transformer
				doc:name="Transform BatchJobInstance to JSON" />
			<logger message="#INFO: [#[message]]" level="INFO" doc:name="Logger" />
		</batch:on-complete>
	</batch:job>




</mule>
